#!/bin/bash

set -eux

<<<<<<< HEAD
if [ "$#" -le 4 ]; then
    echo "Invalid parameters"
    echo "Usage: $0 VMUUID VMPASSWORD XENSERVER_HOST XENSERVER_USERNAME SCRIPT [PARAMETERS]"
    exit 1
fi

. ./functions.sh

VMUUID=$1
VMPASSWORD=$2
XENSERVER_HOST=$3
XENSERVER_PASSWORD=$4
SCRIPT=$5

XENSERVER_USERNAME="root"

# Make sure that the VM exists
xecommand vm-list uuid="$VMUUID" | exit 1

# Make sure that the VM is running
xecommand vm-start uuid="$VMUUID" | true
=======
if [ "$#" -ne 5 ]; then
    echo "Invalid parameters"
    echo "Usage: $0 vmuuid password script xenserver_host xenserver_password"
    exit 1
fi

. ./function.sh

VMUUID=$1
PASSWORD=$2
SCRIPT=$3
XENSERVER_HOST=$4
XENSERVER_PASSWORD=$5
>>>>>>> d200d646daff5d5ababbff6f1ab7275a7e449969

# Wait for SSH
ip=""
while [[ $ip == "" ]]; do
    sleep 1
    ip=$(xecommand vm-param-get uuid="$VMUUID" param-name=networks | sed -ne 's,^.*0/ip: \([0-9.]*\).*$,\1,p')
    if [[ $ip != "" ]]; then
        if [[ $(sshcommand "echo ok") != "ok" ]]; then
            ip=""
        fi
    fi
done

<<<<<<< HEAD
# Copy over the scripts and execute
tmpdir=$(sshcommand mktemp -d)
sshpass -p "$VMPASSWORD" scp -o StrictHostKeyChecking=no -r ./ root@"$ip":"$tmpdir"
basename=$(basename "$SCRIPT")
sshpass -p "$VMPASSWORD" ssh -o StrictHostKeyChecking=no root@"$ip" "$tmpdir/$basename" "${@:6}"
=======
tmpdir=$(sshcommand mktemp -d)
sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no -r ./ root@"$ip":"$tmpdir"
$basename=$(basename "$SCRIPT")
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@"$ip" "$tmpdir/$basename $CCP $SYSTEMVM" 
>>>>>>> d200d646daff5d5ababbff6f1ab7275a7e449969
